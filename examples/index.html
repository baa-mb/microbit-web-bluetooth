<html>
    <head>
        <title>micro:bit</title>
        <script type="text/javascript" src="../dist/microbit.umd.js"></script>
    </head>
    <body>
        <button id="find">find</button>
        <script>
            document.getElementById("find").onclick = async () => {
                const device = await microbit.requestMicrobit(window.navigator.bluetooth);
                if (device) {
                    const services = await microbit.getServices(device);

                    if (services.deviceInformationService) {
                        console.log(await services.deviceInformationService.readDeviceInformation());
                    }

                    if (services.uartService) {
                        const uartHandler = data => console.log(data.detail);
                        services.uartService.addEventListener("receiveString", uartHandler);
                        await services.uartService.send(new Uint8Array([104, 101, 108, 108, 111, 58])); // hello:
                    }

                    if (services.ledService) {
                        await services.ledService.setScrollingDelay(50);
                        await services.ledService.setMatrixState([
                            [1, 0, 1, 0, 0],
                            [1, 1, 1, 1, 1],
                            [0, 0, 1, 0, 0],
                            [0, 1, 0, 1, 0],
                            [1, 0, 0, 0, 1]
                        ]);
                        console.log(await services.ledService.getMatrixState());
                        await services.ledService.writeText("Web BLE");
                    }

                    if (services.buttonService) {
                        const buttonHandler = data => console.log(data);
                        services.buttonService.addEventListener("buttonastatechanged", buttonHandler);
                        services.buttonService.addEventListener("buttonbstatechanged", buttonHandler);
                    }

                    if (services.temperatureService) {
                        await services.temperatureService.setTemperaturePeriod(200);
                        const temperatureHandler = data => console.log(data);
                        services.temperatureService.addEventListener("temperaturechanged", temperatureHandler);
                    }

                    if (services.accelerometerService) {
                        await services.accelerometerService.setAccelerometerPeriod(80);
                        const accelerometerHandler = data => console.log(data.detail);
                        services.accelerometerService.addEventListener("accelerometerdatachanged", accelerometerHandler);
                    }

                    if (services.magnetometerService) {
                        const startMagnetometer = async () => {
                            await services.magnetometerService.setMagnetometerPeriod(80);
                            console.log(await services.magnetometerService.getMagnetometerPeriod());
                            const magnetometerHandler = data => console.log(data.detail);
                            services.magnetometerService.addEventListener("magnetometerdatachanged", magnetometerHandler);
                            services.magnetometerService.addEventListener("magnetometerbearingchanged", magnetometerHandler);
                        };

                        services.magnetometerService.addEventListener("magnetometercalibrationchanged", async response => {
                            if (response.detail === 2) {
                                await startMagnetometer();
                            }
                        });

                        try {
                            await services.magnetometerService.calibrate();
                        } catch (e) {
                            await startMagnetometer();
                        }
                    }
                }
            }
        </script>
    </body>
</html>
